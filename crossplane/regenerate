#!/bin/bash

set -e

version="v${1}"

if [[ "$version" = v ]]; then
    echo "Please specify version of crossplane you want to generate schemas for" >&2
    exit 1
fi


cd "$(dirname "${BASH_SOURCE[0]}")"

clone_dir="$(mktemp -d)"
trap 'rm -rf "$clone_dir"' EXIT

git clone --depth 1 -b "${version}" https://github.com/crossplane/crossplane "$clone_dir/crossplane"

kcl_dir="$(pwd)"

find . \
    '!' -path "./$(basename "${BASH_SOURCE[0]}")" \
    '!' -name '*.md' \
    -delete

kcl mod init --version "${version%v}"
rm main.k
kcl mod add k8s

for r in crds meta; do
    crd_dir="${clone_dir}/crossplane/cluster/$r"

    groups=( $(find "${crd_dir}" -type f -printf '%f\n' | sed 's/_[^_]*$//' | sort | uniq) )
    for g in "${groups[@]%.crossplane.io}" ; do
        if [[ "$g" = "crossplane.io" ]]; then
            continue
        else
            p="${g/.//}"
        fi
        (
            mkdir -p "$(dirname "$p")"
            cd "$(dirname "$p")"
            kcl import -m crd -p "$(basename "$p")" "${crd_dir}/${g}"*.yaml
        )
    done
done

# delete autogenerated mod files and duplicite k8s module
find . -path  '**/k8s**' -delete
find . -name kcl.mod '!' -path './kcl.mod' -delete
# rm -r ./*/kcl.mod ./*/k8s/
